<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>

    <title>Barchart Portfolio Client API</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" type="text/css">
    <link rel="stylesheet" href="example.css" type="text/css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.23.0/polyfill.min.js"></script>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script src="example.js"></script>

    <script type="text/javascript">
		'use strict';

		var PageModel = function() {
			var that = this;

			that.gateway = null;

			that.user = ko.observable('22e59613-d393-4069-814c-f0b5a3e4b31e');
			that.userLegacy = ko.observable('16399446');

			that.connected = ko.observable(false);
			that.connecting = ko.observable(false);

			that.activeTemplate = ko.observable('disconnected-template');
			that.console = ko.observableArray([ ]);

			that.portfolio = ko.observable();
			that.position = ko.observable();
			that.transaction = ko.observable();

			that.clientVersion = ko.observable(Barchart.Portfolio.version);

			var getPortfolios = function() {
				var action = 'portfolioGateway.readPortfolios()';

				that.gateway.readPortfolios(that.portfolio() || null)
					.then((data) => {
						writeConsoleText(action, true);
						writeConsoleObject(data);
					}).catch((e) => {
                        writeConsoleText(action, true);
                        writeConsoleObject(e);

                        that.setConsoleMode();
                    });
			};
			var createPortfolio = function () {
				var action = 'portfolioGateway.createPortfolio()';

				var portfolio = {
					name: `Random ${Math.random()}`,
					timezone: 'America/New_York',
					dates: {
						create: Barchart.Day.getToday(),
						cash: Barchart.Day.getToday()
					},
					defaults: {
						currency: 'CAD',
						reinvest: true,
						valuation: 'AVG'
					},
					data: {}
				};

				that.gateway.createPortfolio(portfolio)
					.then((data) => {
						writeConsoleText(action, true);
						writeConsoleObject(data);
					}).catch((e) => {
                        writeConsoleText(action, true);
                        writeConsoleObject(e);

                        that.setConsoleMode();
                    });
			};
			var updatePortfolio = function() {
				var action = 'portfolioGateway.updatePortfolio()';

				var portfolio = {
					name: `Random ${Math.random()}`,
					timezone: 'America/New_York',
					dates: {
						cash: Barchart.Day.getToday()
					},
					defaults: {
						currency: 'CAD',
						reinvest: true,
						valuation: 'AVG'
					},
					data: {}
				};

				if (!that.portfolio()) {
					toastr.info('A "portfolio" is required.');
				    return;
                }

				that.gateway.updatePortfolio(that.portfolio(), portfolio)
					.then((data) => {
						writeConsoleText(action, true);
						writeConsoleObject(data);
					}).catch((e) => {
                        writeConsoleText(action, true);
                        writeConsoleObject(e);

                        that.setConsoleMode();
                    });
			};
			var getPositions = function() {
				var action = 'portfolioGateway.readPositions()';

				that.gateway.readPositions(that.portfolio() || null, that.position() || null)
					.then((data) => {
						writeConsoleText(action, true);
						writeConsoleObject(data);
					}).catch((e) => {
                        writeConsoleText(action, true);
                        writeConsoleObject(e);

                        that.setConsoleMode();
                    });
			};
			var getTransactions = function() {
				var action = 'portfolioGateway.readTransactions()';

				var portfolio = that.portfolio();
				var position = that.position();

				if (!portfolio) {
					toastr.info('A "portfolio" is required.');
				    return;
                }

				that.gateway.readTransactions(that.portfolio(), that.position() || null)
					.then((data) => {
						writeConsoleText(action, true);
						writeConsoleObject(data);
					}).catch((e) => {
                        writeConsoleText(action, true);
                        writeConsoleObject(e);

                        that.setConsoleMode();
                    });
			};
			var getTransactionsFormatted = function() {
				var action = 'portfolioGateway.readTransactionsFormatted()';

				var portfolio = that.portfolio();
				var position = that.position();

				if (!portfolio) {
					toastr.info('A "portfolio" is required.');
					return;
				}

				that.gateway.readTransactionsFormatted(that.portfolio(), that.position() || null)
                    .then((data) => {
                        writeConsoleText(action, true);
                        writeConsoleObject(data);
                    }).catch((e) => {
                        writeConsoleText(action, true);
                        writeConsoleObject(e);

                        that.setConsoleMode();
                    });
			};

			that.modes = ko.observableArray([
				{ text: 'Get Portfolios', action: getPortfolios },
                { text: 'Create Portfolio', action: createPortfolio },
                { text: 'Update Portfolio', action: updatePortfolio },
                { text: 'Get Positions', action: getPositions },
                { text: 'Get Transactions', action: getTransactions },
                { text: 'Get Transactions (Formatted)', action: getTransactionsFormatted }
            ]);

			that.mode = ko.observable(that.modes()[0]);


			that.canConnect = ko.computed(function() {
				return !that.connecting() && !that.connected();
			});
			that.canDisconnect = ko.computed(function() {
				return that.connected();
			});

			var writeConsoleText = function(text, clear) {
				if (clear) {
					that.console.removeAll();
				}

				that.console.push(text);
			};

			var writeConsoleObject = function(data) {
				that.console.push(JSON.stringify(data, null, 2));
			};

			that.setConsoleMode = function() {
				that.activeTemplate('portfolio-console-template');
			};

			that.connect = function() {
				that.disconnect();
				
				if (!that.user() || !that.userLegacy()) {
					return;
                }

				that.connecting(true);

				Barchart.Portfolio.PortfolioGateway.forDevelopment(Barchart.Portfolio.JwtGateway.forDevelopmentClient(that.user(), that.userLegacy()))
                    .then((gateway) => {
					    that.gateway = gateway;

						that.connecting(false);
						that.connected(true);

						that.setConsoleMode();

						getPortfolios();
                    });
			};
			that.disconnect = function() {
				if (that.gateway === null) {
					return;
                }

                if (that.gateway) {
	                that.gateway.dispose();
	                that.gateway = null;
                }

				that.console.removeAll();

				that.connecting(false);
				that.connected(false);

				that.activeTemplate('disconnected-template');
			};

			that.setMode = function(mode) {
                that.mode(mode);

                that.execute();
            };
			that.execute = function() {
				that.mode().action();
            };

			that.handleLoginKeypress = function(d, e) {
				var enterKey = e.keyCode === 13;

				if (enterKey) {
					that.connect();
				}

				return !enterKey;
			};
		};

		var pageModel

		$(document).ready(function() {
			pageModel = new PageModel();

            ko.applyBindings(pageModel, $('body')[0]);
		});
    </script>

    <script type="text/html" id="disconnected-template">
        <div class="container-center-outer">
            <div class="container-center-inner">
                <form class="form-horizontal login">
                    <div class="form-group" data-bind="css: { 'has-error': user().length === 0 }, event: { keypress: handleLoginKeypress }">
                        <label class="pull-left">User</label>
                        <input class="form-control" data-bind="textInput: user" type="text" placeholder="User">
                    </div>
                    <div class="form-group" data-bind="css: { 'has-error': user().length === 0 }, event: { keypress: handleLoginKeypress }">
                        <label class="pull-left">Legacy User</label>
                        <input class="form-control" data-bind="textInput: userLegacy" type="text" placeholder="Legacy User">
                    </div>
                    <div class="form-group buttons">
                        <button class="form-control btn btn-primary" type="button" data-bind="click: connect, enable: canConnect">Connect</button>
                    </div>
                </form>
            </div>
        </div>
    </script>

    <script type="text/html" id="portfolio-header-template">
        <div class="pull-left">
            <h4 class="pull-left">Barchart Portfolio API <span data-bind="visible: connected"></span></h4>

            <div class="pull-left header-action-buttons form-inline" style="margin-top: 12px;" data-bind="visible: connected() === true">
                <input class="form-control" data-bind="value: portfolio" type="text" placeholder="Portfolio">
                <input class="form-control" data-bind="value: position" type="text" placeholder="Position">
                <input class="form-control" data-bind="value: transaction" type="text" placeholder="Transaction">
            </div>
        </div>

        <div class="pull-left">
            <div class="pull-left header-action-buttons form-inline" data-bind="visible: connected() === true">
                <div class="dropdown" style="margin-top: 8px;">
                    <button class="btn btn-default dropdown-toggle" style="width: 200px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <span data-bind="text: mode().text"></span>
                    </button>
                    <ul class="dropdown-menu" data-bind="foreach: modes">
                        <li class="center"><a href="#" data-bind="text: $data.text, click: function() { $parent.setMode($data); }"></a></li>
                    </ul>
                </div>
            </div>

            <div class="pull-left header-action-buttons form-inline" data-bind="visible: connected() === true">
                <span class="text-button glyphicon glyphicon-play" data-bind="click: execute"></span>
            </div>
        </div>

        <div class="pull-right">
            <div class="header-action-buttons pull-right form-inline" data-bind="visible: connected() === true">
                <span class="text-button glyphicon glyphicon-remove" data-bind="click: disconnect"></span>
            </div>
        </div>
    </script>

    <script type="text/html" id="portfolio-console-template">
        <div data-bind="foreach: console">
            <pre data-bind="text: $data" style="font-size: 10px;"></pre>
        </div>
    </script>

    <script type="text/html" id="footer-template">
        <h4 class="pull-left" data-bind="visible: connected">
            Client Version: <span data-bind="text: clientVersion"></span>
        </h4>
        <h4 class="pull-right">
            User: <span data-bind="text: user"></span>
        </h4>
    </script>
</head>
<body>
<div class="header" data-bind="template: { name: 'portfolio-header-template' }"></div>
<div class="main" data-bind="template: { name: activeTemplate }"></div>
<div class="footer" data-bind="template: { name: 'footer-template' }">
</div>
</body>
</html>