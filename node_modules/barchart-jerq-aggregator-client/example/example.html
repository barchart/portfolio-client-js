<!DOCTYPE html>
<html lang="en">
<head>
	<title>Barchart Streaming Market Data</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" type="text/css">
	<link rel="stylesheet" href="example.css" type="text/css">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.23.0/polyfill.min.js"></script>

	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

	<script src="../dist/barchart-jerq-aggregator-api-2.3.js"></script>

	<script type="text/javascript">
		'use strict';

		var PageModel = function() {
			var that = this;
			var connection = null;

			that.server = ko.observable('jerq-aggregator-prod.aws.barchart.com');

			that.symbol = ko.observable('');
			that.symbolFocus = ko.observable(false);

			that.mode = ko.observable('Delayed');

			that.activeTemplate = ko.observable('disconnected-template');

			that.version = ko.observable(Barchart.StreamingData.version);

			that.connected = ko.observable(false);
			that.connecting = ko.observable(false);

			that.canConnect = ko.computed(function() {
				return !that.connecting() && !that.connected();
			});
			that.canDisconnect = ko.computed(function() {
				return that.connected();
			});
			that.canReset = ko.computed(function() {
				var connected = that.connected();
				var activeTemplate = that.activeTemplate();

				return connected && activeTemplate !== 'grid-template';
			});

			that.rows = ko.observableArray();
			that.item = ko.observable(null);

			that.status = ko.observable(null);
			that.statusDisplay = ko.computed(function() {
				var status = that.status();

				if (status) {
					return JSON.stringify(status, null, 2);
				} else {
					return 'Loading...';
				}
			});

			var handleConnectionStateChange = function(connectionState) {
				if (connectionState === 'connected') {
					that.connecting(false);
					that.connected(true);

					toastr.info('Server Connection Established');

					that.showGrid();
				} else if (connectionState === 'disconnected') {
					toastr.info('Server Connection Lost');

					that.disconnect();
				}
			};

			that.itemDisplay = ko.computed(function() {
				var item = that.item();

				if (item && item.quote()) {
					return JSON.stringify(item.quote(), null, 2);
				} else {
					return null;
				}
			});

			that.connect = function() {
				that.disconnect();

				var server = that.server();

				if (!server) {
					return;
				}

				that.connecting(true);

				connection = new Barchart.StreamingData.Connection();

				connection.on('connectionStateChange', handleConnectionStateChange);

				connection.connect(server);
			};

			that.disconnect = function() {
				if (connection === null) {
					return;
				}

				connection.disconnect();
				connection = null;

				that.rows.removeAll();

				that.connecting(false);
				that.connected(false);

				that.activeTemplate('disconnected-template');
			};

			that.showStatus = function() {
				that.status(null);

				that.activeTemplate('status-template');

				connection.getSubscriptionStatus()
					.then(function(status) {
						that.status(status);
					});
			};

			that.showOptions = function() {
				$('.modal.options').modal('show');
			};

			that.handleLoginKeypress = function(d, e) {
				var enterKey = e.keyCode === 13;

				if (enterKey) {
					that.connect();
				}

				return !enterKey;
			};

			that.addSymbol = function() {
				var symbols = that.symbol().split(',');
				var mode = that.mode();

				var addSymbol = function(symbol) {
					if (!symbol) {
						return;
					}

					var c;

					if (mode === 'Realtime') {
						c = connection.getRealtime();
					} else {
						c = connection;
					}

					var model = new RowModel(symbol, mode);

					var handleMarketPriceChange = function(quote) {
						model.quote(quote);
					};

					model.setMarketPriceChangeHandler(handleMarketPriceChange);

					c.on('marketPriceChange', handleMarketPriceChange, symbol);

					that.rows.push(model);

					that.showGrid();
				};

				for (var i = 0; i < symbols.length; i++) {
					addSymbol(symbols[i]);
				}
			};

			that.removeSymbol = function(model) {
				if (model.getMarketPriceChangeHandler()) {
					var c;

					if (model.mode === 'Realtime') {
						c = connection.getRealtime();
					} else {
						c = connection;
					}

					c.off('marketPriceChange', model.getMarketPriceChangeHandler(), model.symbol);
				}

				that.rows.remove(model);
			};

			that.handleSymbolKeypress = function(d, e) {
				if (e.keyCode === 13) {
					that.addSymbol();
				}

				return true;
			};

			that.showGrid = function() {
				that.activeTemplate('grid-template');

				that.item(null);
				that.symbolFocus(true);
			};

			that.showItemDetail = function(model) {
				that.symbol(model.symbol);
				that.item(model);

				that.activeTemplate('grid-item-details');
			};

			that.setDelayedMode = function() {
				that.mode('Delayed');
			};

			that.setRealtimeMode = function() {
				that.mode('Realtime');
			};

			that.disconnect();
		};

		var RowModel = function(symbol, mode) {
			var that = this;

			that.symbol = symbol;
			that.mode = mode;

			that.quote = ko.observable(null);

			that.priceLevels = ko.observableArray();
			that.priceLevelLast = ko.observable(null);

			that.handlers = { };

			that.setMarketPriceChangeHandler = function(handler) {
				that.handlers.marketPriceChange = handler;
			};

			that.getMarketPriceChangeHandler = function() {
				return that.handlers.marketPriceChange;
			};
		};

		$(document).ready(function() {
			var pageModel = new PageModel();

			ko.applyBindings(pageModel, $('body')[0]);
		});
	</script>

	<script type="text/html" id="grid-template">
		<table class="table table-striped small">
			<thead>
			<th class="left col-md-1"></th>
			<th class="left col-md-1">Symbol</th>
			<th class="left col-md-1">Mode</th>
			<th class="left col-md-1">Flag</th>
			<th class="left col-md-1">Sequence</th>
			<th class="left col-md-1">Bid Price</th>
			<th class="left col-md-1">Ask Price</th>
			<th class="left col-md-1">Last Price</th>
			<th class="left col-md-1">Volume</th>
			<th class="left col-md-1">Trades</th>
			<th class="left col-md-2">Time</th>
			</thead>
			<tbody data-bind="template: { name: 'grid-item-template', foreach: rows }"></tbody>
		</table>
	</script>

	<script type="text/html" id="grid-item-template">
		<tr>
			<td class="center col-md-1 alert-action-buttons">
				<span class="text-button text-button-black glyphicon glyphicon-search" data-bind="click: function() { $parent.showItemDetail($data); }"></span>
				<span class="text-button text-button-black glyphicon glyphicon-remove" data-bind="click: function() { $parent.removeSymbol($data); }"></span>
			</td>
			<td class="left col-md-1" data-bind="text: symbol"></td>
			<td class="left col-md-1" data-bind="text: mode"></td>
			<!-- ko if: quote() !== null -->
			<!-- ko with: quote -->
			<td class="left col-md-1" data-bind="text: flag"></td>
			<td class="left col-md-1" data-bind="text: sequence"></td>
			<td class="left col-md-1" data-bind="text: bidPrice"></td>
			<td class="left col-md-1" data-bind="text: askPrice"></td>
			<td class="left col-md-1" data-bind="text: lastPrice"></td>
			<td class="left col-md-1" data-bind="text: volume"></td>
			<td class="left col-md-1" data-bind="text: numberOfTrades"></td>
			<td class="left col-md-2" data-bind="text: time"></td>

			<!-- /ko -->
			<!-- /ko -->
			<!-- ko if: quote() === null -->
			<td class="left col-md-1"></td>
			<td class="left col-md-1"></td>
			<td class="left col-md-1"></td>
			<td class="left col-md-1"></td>
			<td class="left col-md-1"></td>
			<td class="left col-md-1"></td>
			<td class="left col-md-1"></td>
			<td class="left col-md-2"></td>
			<!-- /ko -->
		</tr>
	</script>

	<script type="text/html" id="grid-item-details">
		<pre data-bind="text: itemDisplay"></pre>
	</script>

	<script type="text/html" id="status-template">
		<pre data-bind="text: statusDisplay"></pre>
	</script>

	<script type="text/html" id="disconnected-template">
		<div class="container-center-outer">
			<div class="container-center-inner">
				<form class="form-horizontal login">
					<div class="form-group" data-bind="css: { 'has-error': server().length === 0 }, event: { keypress: handleLoginKeypress }">
						<label class="pull-left">Server</label>
						<input class="form-control" data-bind="textInput: server" type="text" placeholder="Server">
					</div>
					<div class="form-group buttons">
						<button class="form-control btn btn-primary" type="button" data-bind="click: connect, enable: canConnect">Connect</button>
					</div>
				</form>
			</div>
		</div>
	</script>

	<script type="text/html" id="header-template">
		<div class="pull-left" data-bind="css: { 'can-reset': canReset}">
			<div class="header-action-buttons form-inline pull-left back-button center">
				<span class="text-button text-button glyphicon glyphicon-arrow-left" data-bind="click: showGrid"></span>
			</div>

			<h4 class="pull-left header-text">Barchart Streaming Market Data</h4>

			<div class="header-action-buttons pull-right form-inline" data-bind="visible: connected">
				<div class="input-group">
					<div class="input-group-btn">
						<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
							<span><span data-bind="text: mode"></span> <span class="caret"></span></span>
						</button>
						<ul class="dropdown-menu dropdown-menu-left">
							<li><a href="#" data-bind="click: setDelayedMode">Delayed</a></li>
							<li><a href="#" data-bind="click: setRealtimeMode">Realtime</a></li>
						</ul>
					</div>
					<input class="form-control" data-bind="textInput: symbol, hasFocus: symbolFocus, event: { keypress: handleSymbolKeypress }" type="text" placeholder="Add Symbol">
				</div>
				<span class="text-button glyphicon glyphicon-plus" data-bind="click: addSymbol"></span>

				<span class="text-button glyphicon glyphicon-earphone" data-bind="click: connect, visible: canConnect"></span>
				<span class="text-button glyphicon glyphicon-info-sign" data-bind="click: showStatus, visible: canDisconnect"></span>
				<!--<span class="text-button glyphicon glyphicon-cog" data-bind="click: showOptions, visible: canDisconnect"></span>-->
				<span class="text-button glyphicon glyphicon-remove" data-bind="click: disconnect, visible: canDisconnect"></span>
			</div>
		</div>
	</script>

	<script type="text/html" id="modal-template">
		<div class="modal fade options" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title">Options</h4>
					</div>
					<div class="modal-body">

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary">Apply</button>
						<button type="button" class="btn btn-primary">Cancel</button>
					</div>
				</div>
			</div>
		</div>
	</script>

	<script type="text/html" id="footer-template">
		<h4 class="pull-left"><a href="https://github.com/barchart/jerq-aggregator-client-js" target="_blank">[jerq-aggregator-client-js]</a><span data-bind="visible: connected"> server: <span data-bind="text: server"></span></span></h4>
		<h4 class="pull-right">Client Version: <span data-bind="text: version()"></span></h4>
	</script>
</head>
<body>
<div class="popup" data-bind="template: { name: 'modal-template' }"></div>
<div class="header" data-bind="template: { name: 'header-template' }"></div>
<div class="main" data-bind="template: { name: activeTemplate }"></div>
<div class="footer" data-bind="template: { name: 'footer-template' }"></div>
</body>
</html>