# barchart-jerq-aggregator-client-js

## A JavaScript library for accessing Barchart's JERQ market data feed

A remote server vends Barchart's market data feed. This client library uses [socket.io](http://socket.io) to access the feed and allows clients to:

* Request basic **Profile** data for individual symbols
* Subscribe to **Quote** updates for individual symbols
* Subscribe to depth of **Book** updates for individual symbols


## Setup

This library is intended for use in the browser or headless JavaScript environments
(i.e. Node.js). It has been released via the usual package managers.


### npm

To import the library as a dependency to your application using npm, use the following command:


	npm install barchart-jerq-aggregator-client -S


### bower

To import the library as a dependency to your application using bower, use the following command:


	bower install barchart-jerq-aggregator-client -S


### git

The git repository is publicaly-accessible here:


	https://github.com/barchart/jerq-aggregator-client-js


## Usage

The Barchart market data server uses [socket.io](http://socket.io) endpoints. This
library is a convenience-wrapper. So, instead of making the socket.io connection
directly, consumers can make single-line method calls to perform asynchronous
operations (e.g. subscribe quotes, subscribe prices, get profile).


### Simple Node.js Example

        var jerqAggregatorClient = require('barchart-jerq-aggregator-client');

        var connection = new jerqAggregatorClient.Connection();

        connection.connect('jerq-aggregator-dev.aws.barchart.com')
            .then(function() {
                connection.on('marketUpdate', function(change) {
                    console.log(change);
                }, [ 'APPL', 'MSFT' ]);
            });


### Simple Browser Example

Add a script tag and access the global variable **Barchart.StreamingData**

        <script src="dist/barchart-jerq-aggregator.js"></script>

        <script>
            var connection = new Barchart.StreamingData.Connection();

            connection.connect('jerq-aggregator-dev.aws.barchart.com')
                .then(function() {
                    connection.on('marketUpdate', function(change) {
                        console.log(change);
                    }, [ 'APPL', 'MSFT' ]);
                });
        </script>


## Example

A sample user interface can be found here:

    ./example/example.html
    
Or, you can load the hosted example page here:

- [https://examples.aws.barchart.com/jerq-aggregator-client-js/example.html](https://examples.aws.barchart.com/jerq-aggregator-client-js/example.html)


## Connecting

After creating an instance of the Barchart.StreamingData.Connection object,
call the "connect" function. This function has three arguments (see below)
and returns a promise.

1. host, required, string, the name of the remote host.
2. secure, optional, boolean, forces connection to secure (or unsecure mode), omit to auto-detect.
3. port, optional, number, the port to use, omit to auto-detect.


## Connection Object Operations

After you created an instance of the Connection object (see above), you
can:

* Request instrument profiles, quote, exchanges
* Subscribe to (and unsubscribe from) quote changes,
* Subscribe to (and unsubscribe from) price changes,
* Subscribe to (and unsubscribe from) book changes, and
* Subscribe to (and unsubscribe from) exchange status changes, and
* Subscribe to (and unsubscribe from) server timestamp updates.


### Lookup Exchange Status

This promise-based request will return the most recent information
about an exchange.

	connection.getMarketState().lookupExchange('NYSE')
		.then(function(exchange) {
			console.log(JSON.stringify(exchange));
		});


### Get Profile

This function will return a profile from the client-side cache. This 
function is synchronous and may return uninitialized or stale data.
The profile instance is guaranteed to be initialized if a quote or
price subscription is active and at least once quote/price message
has been received.

    var profile = connection.getMarketState().getProfile('ESH6');
    var initialized = profile.getIsInitialized();


### Get Exchange

This function will return an exchange from the client-side cache.
Unlike the "lookupExchange"  function, this function is synchronous
and may return uninitialized or stale data.

    var exchange = connection.getMarketState().getProfile('NYSE');
    var initialized = exchange.getIsInitialized();


### Get Quote

This function will return a quote from the client-side cache.
This function is synchronous and may return uninitialized or stale data.

    var quote = connection.getMarketState().getQuote('IBM');
    var initialized = Quote.getIsInitialized(quote);


### Subscribe to Instrument Profile Changes

This subscription will notify you each time an instrument's profile
changes. This is an infrequent occurrence and mostly occurs when
using a "reference" symbol (e.g. ZC*1 is a reference symbol for
the front month of corn futures).

Please note: this subscription will only work if you have
also subscribed to "quote changes" or "price changes" for the
same symbol.

	var onProfileChange = function(profile) {
		// a profile instance (see lib/market/Profile.js)
	};

	// Begin receiving notifications when profile changes

	connection.on('profileChange', onProfileChange, 'ZC*1');

	// Stop receiving notifications

	connection.off('profileChange', onProfileChange, 'ZC*1');


### Subscribe to Quote Changes

This subscription will notify the observing function each time the
instrument's quote changes. This subscription is more resource intensive
than a subscription to price changes.

	var onQuoteChange = function(quote) {
		// a quote instance (see lib/market/Quote.js)
	};

	// Begin receiving notifications when quote changes

	connection.on('marketUpdate', onQuoteChange, 'ESH6');

	// Stop receiving notifications

	connection.off('marketUpdate', onQuoteChange, 'ESH6');


### Subscribe to Price Changes

This subscription will notify the observing function each time the
instrument's price changes. This subscription is less resource intensive
than a subscription to price changes.

	var onPriceChange = function(quote) {
		// a quote instance (see lib/market/Quote.js)
	};

	// Begin receiving notifications each time the best price changes

	connection.on('marketPriceChange', onPriceChange, 'ESH6', 'TSLA', 'AAPL');

	// Stop receiving notifications

	connection.off('marketPriceChange', onPriceChange, 'ESH6');


### Subscribe to Book Changes

This subscription will notify the observing function each time the
instrument's book changes. This is a resource intensive subscription.

	var onBookChange = function(quote) {
		// a book instance (see lib/market/Book.js)
	};

	// Begin receiving notifications each time the best price changes

	connection.on('marketDepth', onBookChange, 'ESH6');

	// Stop receiving notifications

	connection.off('marketDepth', onBookChange, 'ESH6');


### Subscribe to Exchange Status Updates

This subscription will notify the observing function each time an
exchanges status changes (e.g. open, closed, pre-market, post-market).

	var onExchangeChange = function(exchanged) {
		// an exchange instance (see lib/market/Exchange.js)
	};

	// Begin receiving notifications each time the exchange status changes

	connection.on('exchangeStatus', onExchangeChange, 'NYSE');

	// Stop receiving notifications

	connection.off('exchangeStatus', onExchangeChange, 'NYSE');


### Subscribe to Server Timestamp Updates

	var onTimestamp = function(timestamp) {
		console.log(timestamp);
	};

	// Begin receiving timestamp notifications

	connection.on('timestamp', onTimestamp);

	// Stop receiving timestamp notifications

	connection.off('timestamp', onTimestamp);

## Data Formatting

### Price Formatting

The "Quote" object contains a number of price-related properties. These numeric
properties are not ideal for human presentation.

To format prices for human consumption, first obtain a copy of the "Profile" for
the symbol, then call the format function. For example:

	var profile = null;

	connection.getMarketState().getProfile('AAPL')
		.then(function(p) {
			profile = p;
		})

	...

	// Get a user-friendly string for a price property (e.g. bidPrice,
	// askPrice, lastPrice, previousPrice, tradePrice, etc).

	var userFriendlyLastPrice = profile.formatPrice(quote.lastPrice);

	...

	// Get a user-friendly string for price change (show a "+" prefix
	// for positive values).

	var userFriendlyPriceChange = profile.formatPriceChange(quote.priceChange, true);

	...

	// Get a user-friendly string for percent changes.

	var userFriendlyPercentChange = profile.formatPercentChange(quote.percentChange, true);


Note that there are two price-change functions:

* Profile.formatPrice(value, includeSign)
* Profile.formatPriceChange(value, includeSign)

There are also two percent-change functions:

* Profile.formatPercent(value, includeSign)
* Profile.formatPercentChange(value, includeSign)

In both cases, the difference is treatment of zero values. The former will
return a value. The latter will always return the string "unch" when given
a zero value.

## Realtime Data

Depending on the server you are connecting to, you will most likely be receiving
a delayed data feed. If you want more timely data, you have two options. Either
you can pay to receive a realtime feed. Or, you can use a psuedo-realtime mode
where the client subscribes to all "free" market data sources and provides you with
the most recent (and free) information.

To use the realtime mode, do the following:

	var connection = new Barchart.StreamingData.Connection();

	connection.connect('my-server')
		.then(function() {
			var realtimeConnection = connection.getRealtime();
			
			realtimeSubscription.on(...);
		});


### Time Formatting

The "Quote" object has human-readable property called "timeDisplay."


## Environments

### Test

The development environment can be used for testing, but may
be unreliable.

	var connection = new Barchart.StreamingData.Connection();

	connection.connect('jerq-aggregator-test.aws.barchart.com')
		.then(function() {
			// connected ...
		});


### Staging

The staging environment can be used for testing.

	var connection = new Barchart.StreamingData.Connection();

	connection.connect('jerq-aggregator-stage.aws.barchart.com')
		.then(function() {
			// connected ...
		});


### Production

	connection.connect('jerq-aggregator-prod.aws.barchart.com')
		.then(function() {
			// connected ...
		});

or

	connection.connect()
		.then(function() {
			// connected ...
		});


## Unit Testing

Gulp and Jasmine are used. Execute unit tests, as follows:

	gulp test

